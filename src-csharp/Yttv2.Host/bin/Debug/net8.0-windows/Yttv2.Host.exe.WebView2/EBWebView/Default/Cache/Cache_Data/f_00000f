import { createHotContext as __vite__createHotContext } from "/@vite/client";import.meta.hot = __vite__createHotContext("/src/components/YouTubePlayer.jsx");import __vite__cjsImport0_react_jsxDevRuntime from "/node_modules/.vite/deps/react_jsx-dev-runtime.js?v=cd56faf3"; const jsxDEV = __vite__cjsImport0_react_jsxDevRuntime["jsxDEV"];
import * as RefreshRuntime from "/@react-refresh";
const inWebWorker = typeof WorkerGlobalScope !== "undefined" && self instanceof WorkerGlobalScope;
let prevRefreshReg;
let prevRefreshSig;
if (import.meta.hot && !inWebWorker) {
  if (!window.$RefreshReg$) {
    throw new Error(
      "@vitejs/plugin-react can't detect preamble. Something is wrong."
    );
  }
  prevRefreshReg = window.$RefreshReg$;
  prevRefreshSig = window.$RefreshSig$;
  window.$RefreshReg$ = RefreshRuntime.getRefreshReg("C:/Projects/yttv2/src/components/YouTubePlayer.jsx");
  window.$RefreshSig$ = RefreshRuntime.createSignatureFunctionForTransform;
}
var _s = $RefreshSig$();
import __vite__cjsImport3_react from "/node_modules/.vite/deps/react.js?v=cd56faf3"; const React = __vite__cjsImport3_react.__esModule ? __vite__cjsImport3_react.default : __vite__cjsImport3_react; const useEffect = __vite__cjsImport3_react["useEffect"]; const useRef = __vite__cjsImport3_react["useRef"]; const useState = __vite__cjsImport3_react["useState"]; const useCallback = __vite__cjsImport3_react["useCallback"];
import { updateVideoProgress } from "/src/api/playlistApi.js";
import { useLayoutStore } from "/src/store/layoutStore.js";
const extractVideoId = (url) => {
  if (!url) return null;
  if (!url.includes("youtube.com") && !url.includes("youtu.be")) {
    return url;
  }
  const watchMatch = url.match(/[?&]v=([^&]+)/);
  if (watchMatch) return watchMatch[1];
  const shortMatch = url.match(/youtu\.be\/([^?]+)/);
  if (shortMatch) return shortMatch[1];
  return null;
};
const getStoredPlaybackTime = (videoId) => {
  try {
    const stored = localStorage.getItem(`playback_time_${videoId}`);
    return stored ? parseFloat(stored) : 0;
  } catch {
    return 0;
  }
};
const savePlaybackTime = (videoId, time) => {
  try {
    localStorage.setItem(`playback_time_${videoId}`, time.toString());
  } catch (error) {
    console.error("Failed to save playback time:", error);
  }
};
const saveVideoProgress = async (videoId, videoUrl, duration, currentTime) => {
  try {
    await updateVideoProgress(videoId, videoUrl, duration, currentTime);
  } catch (error) {
    console.error("Failed to save video progress to database:", error);
  }
};
const YouTubePlayer = ({ videoUrl, videoId, playerId = "default", onEnded, ...props }) => {
  _s();
  const id = videoId || extractVideoId(videoUrl);
  const iframeRef = useRef(null);
  const playerRef = useRef(null);
  const saveIntervalRef = useRef(null);
  const durationRef = useRef(null);
  const [apiReady, setApiReady] = useState(false);
  const { viewMode } = useLayoutStore();
  const uniquePlayerId = `youtube-player-${playerId}-${id}`;
  useEffect(() => {
    if (window.YT && window.YT.Player) {
      setApiReady(true);
      return;
    }
    if (!window.onYouTubeIframeAPIReady) {
      window.onYouTubeIframeAPIReady = () => {
        setApiReady(true);
      };
      const tag = document.createElement("script");
      tag.src = "https://www.youtube.com/iframe_api";
      const firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    }
  }, []);
  useEffect(() => {
    if (!apiReady) return;
    const container = document.getElementById(uniquePlayerId);
    if (!container) return;
    const resize = () => {
      const iframe = container.querySelector("iframe");
      if (iframe) {
        const parent = container.parentElement;
        if (parent) {
          iframe.style.width = "100%";
          iframe.style.height = "100%";
        }
      }
    };
    resize();
    window.addEventListener("resize", resize);
    return () => window.removeEventListener("resize", resize);
  }, [apiReady, viewMode, uniquePlayerId]);
  useEffect(() => {
    if (!apiReady || !id) return;
    const storedTime = getStoredPlaybackTime(id);
    playerRef.current = new window.YT.Player(uniquePlayerId, {
      videoId: id,
      playerVars: {
        autoplay: 1,
        start: Math.floor(storedTime),
        enablejsapi: 1
      },
      events: {
        onReady: (event) => {
          try {
            const duration = event.target.getDuration();
            if (duration && duration > 0) {
              durationRef.current = duration;
            }
          } catch (e) {
            console.error("Failed to get video duration:", e);
          }
          setTimeout(() => {
            const container = document.getElementById(uniquePlayerId);
            if (container) {
              const iframe = container.querySelector("iframe");
              if (iframe) {
                iframe.style.width = "100%";
                iframe.style.height = "100%";
              }
            }
          }, 200);
          if (storedTime > 0) {
            const duration = event.target.getDuration();
            const isNearEnd = storedTime >= duration - 10 || duration > 0 && storedTime / duration > 0.95;
            if (isNearEnd) {
              console.log("Video finished previously, restarting from 0");
              event.target.seekTo(0, true);
              savePlaybackTime(id, 0);
            } else {
              event.target.seekTo(storedTime, true);
            }
          }
        },
        onStateChange: (event) => {
          if (event.data === window.YT.PlayerState.ENDED) {
            savePlaybackTime(id, 0);
            const duration = durationRef.current || playerRef.current?.getDuration?.() || 0;
            saveVideoProgress(id, videoUrl || `https://www.youtube.com/watch?v=${id}`, duration, 0);
            if (onEnded) {
              onEnded();
            }
            return;
          }
          if (event.data === window.YT.PlayerState.PLAYING) {
            saveIntervalRef.current = setInterval(() => {
              if (playerRef.current && playerRef.current.getCurrentTime) {
                try {
                  const currentTime = playerRef.current.getCurrentTime();
                  const duration = durationRef.current || playerRef.current.getDuration?.() || null;
                  savePlaybackTime(id, currentTime);
                  saveVideoProgress(id, videoUrl || `https://www.youtube.com/watch?v=${id}`, duration, currentTime);
                } catch (e) {
                }
              }
            }, 5e3);
          } else {
            if (playerRef.current && playerRef.current.getCurrentTime) {
              try {
                const currentTime = playerRef.current.getCurrentTime();
                const duration = durationRef.current || playerRef.current.getDuration?.() || null;
                savePlaybackTime(id, currentTime);
                saveVideoProgress(id, videoUrl || `https://www.youtube.com/watch?v=${id}`, duration, currentTime);
              } catch (e) {
              }
            }
            if (saveIntervalRef.current) {
              clearInterval(saveIntervalRef.current);
              saveIntervalRef.current = null;
            }
          }
        }
      }
    });
    return () => {
      if (playerRef.current) {
        try {
          if (playerRef.current.getCurrentTime) {
            const currentTime = playerRef.current.getCurrentTime();
            const duration = durationRef.current || playerRef.current.getDuration?.() || null;
            savePlaybackTime(id, currentTime);
            saveVideoProgress(id, videoUrl || `https://www.youtube.com/watch?v=${id}`, duration, currentTime);
          }
          if (playerRef.current.destroy) {
            playerRef.current.destroy();
          }
        } catch (e) {
        }
      }
      if (saveIntervalRef.current) {
        clearInterval(saveIntervalRef.current);
      }
    };
  }, [apiReady, id, videoUrl]);
  if (!id) {
    return /* @__PURE__ */ jsxDEV("div", { className: "flex items-center justify-center w-full h-full bg-black text-white", children: /* @__PURE__ */ jsxDEV("p", { children: "Invalid YouTube URL or ID" }, void 0, false, {
      fileName: "C:/Projects/yttv2/src/components/YouTubePlayer.jsx",
      lineNumber: 276,
      columnNumber: 9
    }, this) }, void 0, false, {
      fileName: "C:/Projects/yttv2/src/components/YouTubePlayer.jsx",
      lineNumber: 275,
      columnNumber: 7
    }, this);
  }
  return /* @__PURE__ */ jsxDEV("div", { className: "w-full h-full bg-black", style: { overflow: "hidden" }, children: /* @__PURE__ */ jsxDEV(
    "div",
    {
      id: uniquePlayerId,
      style: {
        width: "100%",
        height: "100%",
        border: "none",
        boxSizing: "border-box"
      }
    },
    void 0,
    false,
    {
      fileName: "C:/Projects/yttv2/src/components/YouTubePlayer.jsx",
      lineNumber: 283,
      columnNumber: 7
    },
    this
  ) }, void 0, false, {
    fileName: "C:/Projects/yttv2/src/components/YouTubePlayer.jsx",
    lineNumber: 282,
    columnNumber: 5
  }, this);
};
_s(YouTubePlayer, "2ogzgMVM2+Nr7yvFCsdJ3LqcXB4=", false, function() {
  return [useLayoutStore];
});
_c = YouTubePlayer;
export default YouTubePlayer;
var _c;
$RefreshReg$(_c, "YouTubePlayer");
if (import.meta.hot && !inWebWorker) {
  window.$RefreshReg$ = prevRefreshReg;
  window.$RefreshSig$ = prevRefreshSig;
}
if (import.meta.hot && !inWebWorker) {
  RefreshRuntime.__hmr_import(import.meta.url).then((currentExports) => {
    RefreshRuntime.registerExportsForReactRefresh("C:/Projects/yttv2/src/components/YouTubePlayer.jsx", currentExports);
    import.meta.hot.accept((nextExports) => {
      if (!nextExports) return;
      const invalidateMessage = RefreshRuntime.validateRefreshBoundaryAndEnqueueUpdate("C:/Projects/yttv2/src/components/YouTubePlayer.jsx", currentExports, nextExports);
      if (invalidateMessage) import.meta.hot.invalidate(invalidateMessage);
    });
  });
}

//# sourceMappingURL=data:application/json;base64,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R0FBRztBQUFBLFFBQ1Y7QUFBQSxNQUVKO0FBQ0EsVUFBSTNDLGdCQUFnQitCLFNBQVM7QUFDM0J3QixzQkFBY3ZELGdCQUFnQitCLE9BQU87QUFBQSxNQUN2QztBQUFBLElBQ0Y7QUFBQSxFQUNGLEdBQUcsQ0FBQzdCLFVBQVVMLElBQUlSLFFBQVEsQ0FBQztBQUUzQixNQUFJLENBQUNRLElBQUk7QUFDUCxXQUNFLHVCQUFDLFNBQUksV0FBVSxzRUFDYixpQ0FBQyxPQUFFLHlDQUFIO0FBQUE7QUFBQTtBQUFBO0FBQUEsV0FBNEIsS0FEOUI7QUFBQTtBQUFBO0FBQUE7QUFBQSxXQUVBO0FBQUEsRUFFSjtBQUVBLFNBQ0UsdUJBQUMsU0FBSSxXQUFVLDBCQUF5QixPQUFPLEVBQUU0RCxVQUFVLFNBQVMsR0FDbEU7QUFBQSxJQUFDO0FBQUE7QUFBQSxNQUNDLElBQUlwRDtBQUFBQSxNQUNKLE9BQU87QUFBQSxRQUNMcUIsT0FBTztBQUFBLFFBQ1BDLFFBQVE7QUFBQSxRQUNSK0IsUUFBUTtBQUFBLFFBQ1JDLFdBQVc7QUFBQSxNQUNiO0FBQUE7QUFBQSxJQVBGO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQSxFQU9JLEtBUk47QUFBQTtBQUFBO0FBQUE7QUFBQSxTQVVBO0FBRUo7QUFBRS9ELEdBdk5JSixlQUFhO0FBQUEsVUFPSXZCLGNBQWM7QUFBQTtBQUFBMkYsS0FQL0JwRTtBQXlOTixlQUFlQTtBQUFjLElBQUFvRTtBQUFBQyxhQUFBRCxJQUFBIiwibmFtZXMiOlsiUmVhY3QiLCJ1c2VFZmZlY3QiLCJ1c2VSZWYiLCJ1c2VTdGF0ZSIsInVzZUNhbGxiYWNrIiwidXBkYXRlVmlkZW9Qcm9ncmVzcyIsInVzZUxheW91dFN0b3JlIiwiZXh0cmFjdFZpZGVvSWQiLCJ1cmwiLCJpbmNsdWRlcyIsIndhdGNoTWF0Y2giLCJtYXRjaCIsInNob3J0TWF0Y2giLCJnZXRTdG9yZWRQbGF5YmFja1RpbWUiLCJ2aWRlb0lkIiwic3RvcmVkIiwibG9jYWxTdG9yYWdlIiwiZ2V0SXRlbSIsInBhcnNlRmxvYXQiLCJzYXZlUGxheWJhY2tUaW1lIiwidGltZSIsInNldEl0ZW0iLCJ0b1N0cmluZyIsImVycm9yIiwiY29uc29sZSIsInNhdmVWaWRlb1Byb2dyZXNzIiwidmlkZW9VcmwiLCJkdXJhdGlvbiIsImN1cnJlbnRUaW1lIiwiWW91VHViZVBsYXllciIsInBsYXllcklkIiwib25FbmRlZCIsInByb3BzIiwiX3MiLCJpZCIsImlmcmFtZVJlZiIsInBsYXllclJlZiIsInNhdmVJbnRlcnZhbFJlZiIsImR1cmF0aW9uUmVmIiwiYXBpUmVhZHkiLCJzZXRBcGlSZWFkeSIsInZpZXdNb2RlIiwidW5pcXVlUGxheWVySWQiLCJ3aW5kb3ciLCJZVCIsIlBsYXllciIsIm9uWW91VHViZUlmcmFtZUFQSVJlYWR5IiwidGFnIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50Iiwic3JjIiwiZmlyc3RTY3JpcHRUYWciLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsInBhcmVudE5vZGUiLCJpbnNlcnRCZWZvcmUiLCJjb250YWluZXIiLCJnZXRFbGVtZW50QnlJZCIsInJlc2l6ZSIsImlmcmFtZSIsInF1ZXJ5U2VsZWN0b3IiLCJwYXJlbnQiLCJwYXJlbnRFbGVtZW50Iiwic3R5bGUiLCJ3aWR0aCIsImhlaWdodCIsImFkZEV2ZW50TGlzdGVuZXIiLCJyZW1vdmVFdmVudExpc3RlbmVyIiwic3RvcmVkVGltZSIsImN1cnJlbnQiLCJwbGF5ZXJWYXJzIiwiYXV0b3BsYXkiLCJzdGFydCIsIk1hdGgiLCJmbG9vciIsImVuYWJsZWpzYXBpIiwiZXZlbnRzIiwib25SZWFkeSIsImV2ZW50IiwidGFyZ2V0IiwiZ2V0RHVyYXRpb24iLCJlIiwic2V0VGltZW91dCIsImlzTmVhckVuZCIsImxvZyIsInNlZWtUbyIsIm9uU3RhdGVDaGFuZ2UiLCJkYXRhIiwiUGxheWVyU3RhdGUiLCJFTkRFRCIsIlBMQVlJTkciLCJzZXRJbnRlcnZhbCIsImdldEN1cnJlbnRUaW1lIiwiY2xlYXJJbnRlcnZhbCIsImRlc3Ryb3kiLCJvdmVyZmxvdyIsImJvcmRlciIsImJveFNpemluZyIsIl9jIiwiJFJlZnJlc2hSZWckIl0sImlnbm9yZUxpc3QiOltdLCJzb3VyY2VzIjpbIllvdVR1YmVQbGF5ZXIuanN4Il0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VFZmZlY3QsIHVzZVJlZiwgdXNlU3RhdGUsIHVzZUNhbGxiYWNrIH0gZnJvbSAncmVhY3QnO1xyXG5pbXBvcnQgeyB1cGRhdGVWaWRlb1Byb2dyZXNzIH0gZnJvbSAnLi4vYXBpL3BsYXlsaXN0QXBpJztcclxuaW1wb3J0IHsgdXNlTGF5b3V0U3RvcmUgfSBmcm9tICcuLi9zdG9yZS9sYXlvdXRTdG9yZSc7XHJcblxyXG4vKipcclxuICogRXh0cmFjdHMgdmlkZW8gSUQgZnJvbSBZb3VUdWJlIFVSTFxyXG4gKiBTdXBwb3J0cyBmb3JtYXRzOlxyXG4gKiAtIGh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9VklERU9fSURcclxuICogLSBodHRwczovL3lvdXR1LmJlL1ZJREVPX0lEXHJcbiAqIC0gVklERU9fSUQgKGlmIGFscmVhZHkganVzdCBhbiBJRClcclxuICovXHJcbmNvbnN0IGV4dHJhY3RWaWRlb0lkID0gKHVybCkgPT4ge1xyXG4gIGlmICghdXJsKSByZXR1cm4gbnVsbDtcclxuXHJcbiAgLy8gSWYgaXQncyBhbHJlYWR5IGp1c3QgYW4gSURcclxuICBpZiAoIXVybC5pbmNsdWRlcygneW91dHViZS5jb20nKSAmJiAhdXJsLmluY2x1ZGVzKCd5b3V0dS5iZScpKSB7XHJcbiAgICByZXR1cm4gdXJsO1xyXG4gIH1cclxuXHJcbiAgLy8gRXh0cmFjdCBmcm9tIHdhdGNoIFVSTFxyXG4gIGNvbnN0IHdhdGNoTWF0Y2ggPSB1cmwubWF0Y2goL1s/Jl12PShbXiZdKykvKTtcclxuICBpZiAod2F0Y2hNYXRjaCkgcmV0dXJuIHdhdGNoTWF0Y2hbMV07XHJcblxyXG4gIC8vIEV4dHJhY3QgZnJvbSB5b3V0dS5iZSBVUkxcclxuICBjb25zdCBzaG9ydE1hdGNoID0gdXJsLm1hdGNoKC95b3V0dVxcLmJlXFwvKFteP10rKS8pO1xyXG4gIGlmIChzaG9ydE1hdGNoKSByZXR1cm4gc2hvcnRNYXRjaFsxXTtcclxuXHJcbiAgcmV0dXJuIG51bGw7XHJcbn07XHJcblxyXG4vLyBHZXQgc3RvcmVkIHBsYXliYWNrIHRpbWUgZm9yIGEgdmlkZW9cclxuY29uc3QgZ2V0U3RvcmVkUGxheWJhY2tUaW1lID0gKHZpZGVvSWQpID0+IHtcclxuICB0cnkge1xyXG4gICAgY29uc3Qgc3RvcmVkID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oYHBsYXliYWNrX3RpbWVfJHt2aWRlb0lkfWApO1xyXG4gICAgcmV0dXJuIHN0b3JlZCA/IHBhcnNlRmxvYXQoc3RvcmVkKSA6IDA7XHJcbiAgfSBjYXRjaCB7XHJcbiAgICByZXR1cm4gMDtcclxuICB9XHJcbn07XHJcblxyXG4vLyBTYXZlIHBsYXliYWNrIHRpbWUgZm9yIGEgdmlkZW8gKGxvY2FsU3RvcmFnZSBmb3IgcXVpY2sgYWNjZXNzKVxyXG5jb25zdCBzYXZlUGxheWJhY2tUaW1lID0gKHZpZGVvSWQsIHRpbWUpID0+IHtcclxuICB0cnkge1xyXG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oYHBsYXliYWNrX3RpbWVfJHt2aWRlb0lkfWAsIHRpbWUudG9TdHJpbmcoKSk7XHJcbiAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzYXZlIHBsYXliYWNrIHRpbWU6JywgZXJyb3IpO1xyXG4gIH1cclxufTtcclxuXHJcbi8vIFNhdmUgdmlkZW8gcHJvZ3Jlc3MgdG8gZGF0YWJhc2VcclxuY29uc3Qgc2F2ZVZpZGVvUHJvZ3Jlc3MgPSBhc3luYyAodmlkZW9JZCwgdmlkZW9VcmwsIGR1cmF0aW9uLCBjdXJyZW50VGltZSkgPT4ge1xyXG4gIHRyeSB7XHJcbiAgICBhd2FpdCB1cGRhdGVWaWRlb1Byb2dyZXNzKHZpZGVvSWQsIHZpZGVvVXJsLCBkdXJhdGlvbiwgY3VycmVudFRpbWUpO1xyXG4gIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2F2ZSB2aWRlbyBwcm9ncmVzcyB0byBkYXRhYmFzZTonLCBlcnJvcik7XHJcbiAgICAvLyBEb24ndCB0aHJvdyAtIHRoaXMgaXMgbm9uLWNyaXRpY2FsXHJcbiAgfVxyXG59O1xyXG5cclxuY29uc3QgWW91VHViZVBsYXllciA9ICh7IHZpZGVvVXJsLCB2aWRlb0lkLCBwbGF5ZXJJZCA9ICdkZWZhdWx0Jywgb25FbmRlZCwgLi4ucHJvcHMgfSkgPT4ge1xyXG4gIGNvbnN0IGlkID0gdmlkZW9JZCB8fCBleHRyYWN0VmlkZW9JZCh2aWRlb1VybCk7XHJcbiAgY29uc3QgaWZyYW1lUmVmID0gdXNlUmVmKG51bGwpO1xyXG4gIGNvbnN0IHBsYXllclJlZiA9IHVzZVJlZihudWxsKTtcclxuICBjb25zdCBzYXZlSW50ZXJ2YWxSZWYgPSB1c2VSZWYobnVsbCk7XHJcbiAgY29uc3QgZHVyYXRpb25SZWYgPSB1c2VSZWYobnVsbCk7IC8vIFN0b3JlIHZpZGVvIGR1cmF0aW9uXHJcbiAgY29uc3QgW2FwaVJlYWR5LCBzZXRBcGlSZWFkeV0gPSB1c2VTdGF0ZShmYWxzZSk7XHJcbiAgY29uc3QgeyB2aWV3TW9kZSB9ID0gdXNlTGF5b3V0U3RvcmUoKTtcclxuXHJcbiAgLy8gQ3JlYXRlIHVuaXF1ZSBwbGF5ZXIgSUQgdXNpbmcgYm90aCB2aWRlbyBJRCBhbmQgcGxheWVyIGluc3RhbmNlIElEXHJcbiAgY29uc3QgdW5pcXVlUGxheWVySWQgPSBgeW91dHViZS1wbGF5ZXItJHtwbGF5ZXJJZH0tJHtpZH1gO1xyXG5cclxuICAvLyBMb2FkIFlvdVR1YmUgSUZyYW1lIEFQSVxyXG4gIHVzZUVmZmVjdCgoKSA9PiB7XHJcbiAgICBpZiAod2luZG93LllUICYmIHdpbmRvdy5ZVC5QbGF5ZXIpIHtcclxuICAgICAgc2V0QXBpUmVhZHkodHJ1ZSk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXdpbmRvdy5vbllvdVR1YmVJZnJhbWVBUElSZWFkeSkge1xyXG4gICAgICB3aW5kb3cub25Zb3VUdWJlSWZyYW1lQVBJUmVhZHkgPSAoKSA9PiB7XHJcbiAgICAgICAgc2V0QXBpUmVhZHkodHJ1ZSk7XHJcbiAgICAgIH07XHJcblxyXG4gICAgICBjb25zdCB0YWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcclxuICAgICAgdGFnLnNyYyA9ICdodHRwczovL3d3dy55b3V0dWJlLmNvbS9pZnJhbWVfYXBpJztcclxuICAgICAgY29uc3QgZmlyc3RTY3JpcHRUYWcgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnc2NyaXB0JylbMF07XHJcbiAgICAgIGZpcnN0U2NyaXB0VGFnLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKHRhZywgZmlyc3RTY3JpcHRUYWcpO1xyXG4gICAgfVxyXG4gIH0sIFtdKTtcclxuXHJcbiAgLy8gU2ltcGxlIHJlc2l6ZSB3aGVuIHBsYXllciBpcyByZWFkeSAtIGp1c3Qgc2V0IHRvIDEwMCVcclxuICB1c2VFZmZlY3QoKCkgPT4ge1xyXG4gICAgaWYgKCFhcGlSZWFkeSkgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVuaXF1ZVBsYXllcklkKTtcclxuICAgIGlmICghY29udGFpbmVyKSByZXR1cm47XHJcblxyXG4gICAgY29uc3QgcmVzaXplID0gKCkgPT4ge1xyXG4gICAgICBjb25zdCBpZnJhbWUgPSBjb250YWluZXIucXVlcnlTZWxlY3RvcignaWZyYW1lJyk7XHJcbiAgICAgIGlmIChpZnJhbWUpIHtcclxuICAgICAgICBjb25zdCBwYXJlbnQgPSBjb250YWluZXIucGFyZW50RWxlbWVudDtcclxuICAgICAgICBpZiAocGFyZW50KSB7XHJcbiAgICAgICAgICAvLyBTaW1wbGU6IGFsd2F5cyAxMDAlIG9mIHBhcmVudFxyXG4gICAgICAgICAgaWZyYW1lLnN0eWxlLndpZHRoID0gJzEwMCUnO1xyXG4gICAgICAgICAgaWZyYW1lLnN0eWxlLmhlaWdodCA9ICcxMDAlJztcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH07XHJcblxyXG4gICAgLy8gUmVzaXplIHdoZW4gdmlld01vZGUgY2hhbmdlc1xyXG4gICAgcmVzaXplKCk7XHJcbiAgICBcclxuICAgIC8vIEFsc28gcmVzaXplIG9uIHdpbmRvdyByZXNpemVcclxuICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdyZXNpemUnLCByZXNpemUpO1xyXG4gICAgcmV0dXJuICgpID0+IHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdyZXNpemUnLCByZXNpemUpO1xyXG4gIH0sIFthcGlSZWFkeSwgdmlld01vZGUsIHVuaXF1ZVBsYXllcklkXSk7XHJcblxyXG4gIC8vIEluaXRpYWxpemUgcGxheWVyIHdoZW4gQVBJIGlzIHJlYWR5IGFuZCB3ZSBoYXZlIGEgdmlkZW8gSURcclxuICB1c2VFZmZlY3QoKCkgPT4ge1xyXG4gICAgaWYgKCFhcGlSZWFkeSB8fCAhaWQpIHJldHVybjtcclxuXHJcbiAgICBjb25zdCBzdG9yZWRUaW1lID0gZ2V0U3RvcmVkUGxheWJhY2tUaW1lKGlkKTtcclxuXHJcbiAgICBwbGF5ZXJSZWYuY3VycmVudCA9IG5ldyB3aW5kb3cuWVQuUGxheWVyKHVuaXF1ZVBsYXllcklkLCB7XHJcbiAgICAgIHZpZGVvSWQ6IGlkLFxyXG4gICAgICBwbGF5ZXJWYXJzOiB7XHJcbiAgICAgICAgYXV0b3BsYXk6IDEsXHJcbiAgICAgICAgc3RhcnQ6IE1hdGguZmxvb3Ioc3RvcmVkVGltZSksXHJcbiAgICAgICAgZW5hYmxlanNhcGk6IDEsXHJcbiAgICAgIH0sXHJcbiAgICAgIGV2ZW50czoge1xyXG4gICAgICAgIG9uUmVhZHk6IChldmVudCkgPT4ge1xyXG4gICAgICAgICAgLy8gR2V0IGFuZCBzdG9yZSB2aWRlbyBkdXJhdGlvblxyXG4gICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgY29uc3QgZHVyYXRpb24gPSBldmVudC50YXJnZXQuZ2V0RHVyYXRpb24oKTtcclxuICAgICAgICAgICAgaWYgKGR1cmF0aW9uICYmIGR1cmF0aW9uID4gMCkge1xyXG4gICAgICAgICAgICAgIGR1cmF0aW9uUmVmLmN1cnJlbnQgPSBkdXJhdGlvbjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gZ2V0IHZpZGVvIGR1cmF0aW9uOicsIGUpO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIC8vIFNpbXBsZSByZXNpemUgLSBqdXN0IHNldCBpZnJhbWUgdG8gMTAwJVxyXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKHVuaXF1ZVBsYXllcklkKTtcclxuICAgICAgICAgICAgaWYgKGNvbnRhaW5lcikge1xyXG4gICAgICAgICAgICAgIGNvbnN0IGlmcmFtZSA9IGNvbnRhaW5lci5xdWVyeVNlbGVjdG9yKCdpZnJhbWUnKTtcclxuICAgICAgICAgICAgICBpZiAoaWZyYW1lKSB7XHJcbiAgICAgICAgICAgICAgICBpZnJhbWUuc3R5bGUud2lkdGggPSAnMTAwJSc7XHJcbiAgICAgICAgICAgICAgICBpZnJhbWUuc3R5bGUuaGVpZ2h0ID0gJzEwMCUnO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSwgMjAwKTtcclxuXHJcbiAgICAgICAgICAvLyBTZWVrIHRvIHN0b3JlZCB0aW1lIGlmIGF2YWlsYWJsZVxyXG4gICAgICAgICAgaWYgKHN0b3JlZFRpbWUgPiAwKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gZXZlbnQudGFyZ2V0LmdldER1cmF0aW9uKCk7XHJcbiAgICAgICAgICAgIC8vIFNtYXJ0IFJlc3VtZTogSWYgc3RvcmVkIHRpbWUgaXMgbmVhciB0aGUgZW5kICh3aXRoaW4gMTBzIGFzIFlvdVR1YmUgYnVmZmVycyBtb3JlLCBvciA5NSUpLCBzdGFydCBmcm9tIGJlZ2lubmluZ1xyXG4gICAgICAgICAgICBjb25zdCBpc05lYXJFbmQgPSBzdG9yZWRUaW1lID49IGR1cmF0aW9uIC0gMTAgfHwgKGR1cmF0aW9uID4gMCAmJiBzdG9yZWRUaW1lIC8gZHVyYXRpb24gPiAwLjk1KTtcclxuXHJcbiAgICAgICAgICAgIGlmIChpc05lYXJFbmQpIHtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZygnVmlkZW8gZmluaXNoZWQgcHJldmlvdXNseSwgcmVzdGFydGluZyBmcm9tIDAnKTtcclxuICAgICAgICAgICAgICBldmVudC50YXJnZXQuc2Vla1RvKDAsIHRydWUpO1xyXG4gICAgICAgICAgICAgIHNhdmVQbGF5YmFja1RpbWUoaWQsIDApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgIGV2ZW50LnRhcmdldC5zZWVrVG8oc3RvcmVkVGltZSwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH1cclxuICAgICAgICB9LFxyXG4gICAgICAgIG9uU3RhdGVDaGFuZ2U6IChldmVudCkgPT4ge1xyXG4gICAgICAgICAgLy8gVmlkZW8gZW5kZWRcclxuICAgICAgICAgIGlmIChldmVudC5kYXRhID09PSB3aW5kb3cuWVQuUGxheWVyU3RhdGUuRU5ERUQpIHtcclxuICAgICAgICAgICAgLy8gUmVzZXQgcHJvZ3Jlc3NcclxuICAgICAgICAgICAgc2F2ZVBsYXliYWNrVGltZShpZCwgMCk7XHJcbiAgICAgICAgICAgIGNvbnN0IGR1cmF0aW9uID0gZHVyYXRpb25SZWYuY3VycmVudCB8fCBwbGF5ZXJSZWYuY3VycmVudD8uZ2V0RHVyYXRpb24/LigpIHx8IDA7XHJcbiAgICAgICAgICAgIHNhdmVWaWRlb1Byb2dyZXNzKGlkLCB2aWRlb1VybCB8fCBgaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0ke2lkfWAsIGR1cmF0aW9uLCAwKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChvbkVuZGVkKSB7XHJcbiAgICAgICAgICAgICAgb25FbmRlZCgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAvLyBTYXZlIHRpbWUgcGVyaW9kaWNhbGx5IHdoZW4gcGxheWluZ1xyXG4gICAgICAgICAgaWYgKGV2ZW50LmRhdGEgPT09IHdpbmRvdy5ZVC5QbGF5ZXJTdGF0ZS5QTEFZSU5HKSB7XHJcbiAgICAgICAgICAgIHNhdmVJbnRlcnZhbFJlZi5jdXJyZW50ID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xyXG4gICAgICAgICAgICAgIGlmIChwbGF5ZXJSZWYuY3VycmVudCAmJiBwbGF5ZXJSZWYuY3VycmVudC5nZXRDdXJyZW50VGltZSkge1xyXG4gICAgICAgICAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgICAgICAgY29uc3QgY3VycmVudFRpbWUgPSBwbGF5ZXJSZWYuY3VycmVudC5nZXRDdXJyZW50VGltZSgpO1xyXG4gICAgICAgICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IGR1cmF0aW9uUmVmLmN1cnJlbnQgfHwgcGxheWVyUmVmLmN1cnJlbnQuZ2V0RHVyYXRpb24/LigpIHx8IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgICAvLyBTYXZlIHRvIGxvY2FsU3RvcmFnZSBmb3IgcXVpY2sgYWNjZXNzXHJcbiAgICAgICAgICAgICAgICAgIHNhdmVQbGF5YmFja1RpbWUoaWQsIGN1cnJlbnRUaW1lKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgIC8vIFNhdmUgdG8gZGF0YWJhc2Ugd2l0aCBwcm9ncmVzcyBwZXJjZW50YWdlXHJcbiAgICAgICAgICAgICAgICAgIHNhdmVWaWRlb1Byb2dyZXNzKGlkLCB2aWRlb1VybCB8fCBgaHR0cHM6Ly93d3cueW91dHViZS5jb20vd2F0Y2g/dj0ke2lkfWAsIGR1cmF0aW9uLCBjdXJyZW50VGltZSk7XHJcbiAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnNcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0sIDUwMDApOyAvLyBTYXZlIGV2ZXJ5IDUgc2Vjb25kc1xyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgLy8gU2F2ZSB3aGVuIHBhdXNlZC9zdG9wcGVkXHJcbiAgICAgICAgICAgIGlmIChwbGF5ZXJSZWYuY3VycmVudCAmJiBwbGF5ZXJSZWYuY3VycmVudC5nZXRDdXJyZW50VGltZSkge1xyXG4gICAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjdXJyZW50VGltZSA9IHBsYXllclJlZi5jdXJyZW50LmdldEN1cnJlbnRUaW1lKCk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IGR1cmF0aW9uUmVmLmN1cnJlbnQgfHwgcGxheWVyUmVmLmN1cnJlbnQuZ2V0RHVyYXRpb24/LigpIHx8IG51bGw7XHJcblxyXG4gICAgICAgICAgICAgICAgLy8gU2F2ZSB0byBsb2NhbFN0b3JhZ2VcclxuICAgICAgICAgICAgICAgIHNhdmVQbGF5YmFja1RpbWUoaWQsIGN1cnJlbnRUaW1lKTtcclxuXHJcbiAgICAgICAgICAgICAgICAvLyBTYXZlIHRvIGRhdGFiYXNlIHdpdGggcHJvZ3Jlc3MgcGVyY2VudGFnZVxyXG4gICAgICAgICAgICAgICAgc2F2ZVZpZGVvUHJvZ3Jlc3MoaWQsIHZpZGVvVXJsIHx8IGBodHRwczovL3d3dy55b3V0dWJlLmNvbS93YXRjaD92PSR7aWR9YCwgZHVyYXRpb24sIGN1cnJlbnRUaW1lKTtcclxuICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgICAgICAgICAgICAvLyBJZ25vcmUgZXJyb3JzXHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChzYXZlSW50ZXJ2YWxSZWYuY3VycmVudCkge1xyXG4gICAgICAgICAgICAgIGNsZWFySW50ZXJ2YWwoc2F2ZUludGVydmFsUmVmLmN1cnJlbnQpO1xyXG4gICAgICAgICAgICAgIHNhdmVJbnRlcnZhbFJlZi5jdXJyZW50ID0gbnVsbDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0sXHJcbiAgICAgIH0sXHJcbiAgICB9KTtcclxuXHJcbiAgICByZXR1cm4gKCkgPT4ge1xyXG4gICAgICAvLyBDbGVhbnVwOiBzYXZlIGZpbmFsIHRpbWUgYW5kIGNsZWFyIGludGVydmFsXHJcbiAgICAgIGlmIChwbGF5ZXJSZWYuY3VycmVudCkge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBpZiAocGxheWVyUmVmLmN1cnJlbnQuZ2V0Q3VycmVudFRpbWUpIHtcclxuICAgICAgICAgICAgY29uc3QgY3VycmVudFRpbWUgPSBwbGF5ZXJSZWYuY3VycmVudC5nZXRDdXJyZW50VGltZSgpO1xyXG4gICAgICAgICAgICBjb25zdCBkdXJhdGlvbiA9IGR1cmF0aW9uUmVmLmN1cnJlbnQgfHwgcGxheWVyUmVmLmN1cnJlbnQuZ2V0RHVyYXRpb24/LigpIHx8IG51bGw7XHJcblxyXG4gICAgICAgICAgICAvLyBTYXZlIHRvIGxvY2FsU3RvcmFnZVxyXG4gICAgICAgICAgICBzYXZlUGxheWJhY2tUaW1lKGlkLCBjdXJyZW50VGltZSk7XHJcblxyXG4gICAgICAgICAgICAvLyBTYXZlIHRvIGRhdGFiYXNlIHdpdGggcHJvZ3Jlc3MgcGVyY2VudGFnZVxyXG4gICAgICAgICAgICBzYXZlVmlkZW9Qcm9ncmVzcyhpZCwgdmlkZW9VcmwgfHwgYGh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9JHtpZH1gLCBkdXJhdGlvbiwgY3VycmVudFRpbWUpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgaWYgKHBsYXllclJlZi5jdXJyZW50LmRlc3Ryb3kpIHtcclxuICAgICAgICAgICAgcGxheWVyUmVmLmN1cnJlbnQuZGVzdHJveSgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgIC8vIElnbm9yZSBlcnJvcnMgZHVyaW5nIGNsZWFudXBcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgICAgaWYgKHNhdmVJbnRlcnZhbFJlZi5jdXJyZW50KSB7XHJcbiAgICAgICAgY2xlYXJJbnRlcnZhbChzYXZlSW50ZXJ2YWxSZWYuY3VycmVudCk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgfSwgW2FwaVJlYWR5LCBpZCwgdmlkZW9VcmxdKTtcclxuXHJcbiAgaWYgKCFpZCkge1xyXG4gICAgcmV0dXJuIChcclxuICAgICAgPGRpdiBjbGFzc05hbWU9XCJmbGV4IGl0ZW1zLWNlbnRlciBqdXN0aWZ5LWNlbnRlciB3LWZ1bGwgaC1mdWxsIGJnLWJsYWNrIHRleHQtd2hpdGVcIj5cclxuICAgICAgICA8cD5JbnZhbGlkIFlvdVR1YmUgVVJMIG9yIElEPC9wPlxyXG4gICAgICA8L2Rpdj5cclxuICAgICk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gKFxyXG4gICAgPGRpdiBjbGFzc05hbWU9XCJ3LWZ1bGwgaC1mdWxsIGJnLWJsYWNrXCIgc3R5bGU9e3sgb3ZlcmZsb3c6ICdoaWRkZW4nIH19PlxyXG4gICAgICA8ZGl2XHJcbiAgICAgICAgaWQ9e3VuaXF1ZVBsYXllcklkfVxyXG4gICAgICAgIHN0eWxlPXt7XHJcbiAgICAgICAgICB3aWR0aDogJzEwMCUnLFxyXG4gICAgICAgICAgaGVpZ2h0OiAnMTAwJScsXHJcbiAgICAgICAgICBib3JkZXI6ICdub25lJyxcclxuICAgICAgICAgIGJveFNpemluZzogJ2JvcmRlci1ib3gnXHJcbiAgICAgICAgfX1cclxuICAgICAgLz5cclxuICAgIDwvZGl2PlxyXG4gICk7XHJcbn07XHJcblxyXG5leHBvcnQgZGVmYXVsdCBZb3VUdWJlUGxheWVyO1xyXG5cclxuIl0sImZpbGUiOiJDOi9Qcm9qZWN0cy95dHR2Mi9zcmMvY29tcG9uZW50cy9Zb3VUdWJlUGxheWVyLmpzeCJ9